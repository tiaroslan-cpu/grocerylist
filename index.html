<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maruko Grocery Checklist</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { background-color: #FFFBEB; font-family: 'Nunito', sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const Icon = ({ name, size = 24, color = "currentColor", fill = "none", strokeWidth = 2, className = "" }) => {
      const iconData = lucide[name];
      if (!iconData) return null;
      return (
        <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke={color} strokeWidth={strokeWidth} strokeLinecap="round" strokeLinejoin="round" className={className}
          dangerouslySetInnerHTML={{ __html: iconData.map(tag => `<${tag[0]} ${Object.entries(tag[1]).map(([k, v]) => `${k}="${v}"`).join(' ')} />`).join('') }} />
      );
    };

    // --- URL WEB APP TERKINI ANDA ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1Az63RdSIb6Uaz_9r7G4gcwW_DcozJFl_lcRWmZLBP5Oq8lWANvvwm0UdoukGpe6Qrg/exec";

    function App() {
      const [activeTab, setActiveTab] = useState('list');
      const [myList, setMyList] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const [statusMsg, setStatusMsg] = useState({ text: '', type: '' });

      // 1. FUNGSI UNTUK MENARIK DATA DARI GOOGLE SHEETS
      const loadDataFromSheets = async () => {
        if (!SCRIPT_URL.startsWith('http')) return;
        setIsLoading(true);
        setStatusMsg({ text: 'Sedang menarik data...', type: 'info' });
        try {
          // Menambah parameter ?action=getData untuk membezakan request
          const response = await fetch(`${SCRIPT_URL}?action=getData`);
          const data = await response.json();
          if (data && data.length > 0) {
            setMyList(data);
            setStatusMsg({ text: 'Data lama berjaya dimuat turun!', type: 'success' });
          } else {
            setStatusMsg({ text: 'Tiada data dijumpai di Cloud.', type: 'info' });
          }
        } catch (error) {
          console.error("Gagal menarik data:", error);
          setStatusMsg({ text: 'Gagal memuat turun data.', type: 'error' });
        } finally {
          setIsLoading(false);
          setTimeout(() => setStatusMsg({ text: '', type: '' }), 3000);
        }
      };

      // Muat data secara automatik apabila aplikasi dibuka
      useEffect(() => {
        loadDataFromSheets();
      }, []);

      const addToMyList = (item) => {
        if (!myList.find(i => i.id === item.id)) {
          setMyList([...myList, { ...item, checked: false, quantity: 1 }]);
        }
      };

      const updateQuantity = (id, delta) => {
        setMyList(myList.map(item => item.id === id ? { ...item, quantity: Math.max(1, item.quantity + delta) } : item));
      };

      const toggleCheck = (id) => {
        setMyList(myList.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
      };

      const removeFromList = (id) => {
        setMyList(myList.filter(item => item.id !== id));
      };

      const saveDataToSheets = async () => {
        if (myList.length === 0) {
          setStatusMsg({ text: 'Tiada barang untuk disimpan!', type: 'error' });
          return;
        }
        setIsLoading(true);
        setStatusMsg({ text: 'Sedang menyimpan ke Cloud...', type: 'info' });
        try {
          const payload = {
            timestamp: new Date().toLocaleString(),
            items: myList.map(item => ({
              nama: item.name,
              kuantiti: item.quantity,
              harga_unit: item.price,
              jumlah: item.price * item.quantity,
              status: item.checked ? 'Dibayar' : 'Belum'
            }))
          };
          // Menggunakan POST untuk menyimpan data
          await fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload) 
          });
          setStatusMsg({ text: 'Berjaya disimpan ke Google Sheets!', type: 'success' });
        } catch (e) {
          setStatusMsg({ text: 'Ralat semasa menyimpan.', type: 'error' });
        } finally {
          setIsLoading(false);
          setTimeout(() => setStatusMsg({ text: '', type: '' }), 3000);
        }
      };

      const totalEstimated = myList.reduce((acc, item) => acc + (item.price * item.quantity), 0);

      return (
        <div className="min-h-screen pb-40">
          <header className="bg-[#FFD93D] border-b-8 border-[#F4B400] p-6 sticky top-0 z-50 shadow-md">
            <div className="max-w-5xl mx-auto flex justify-between items-center">
              <div>
                <h1 className="text-2xl font-black text-[#E63946]">まる子 Grocery</h1>
                <p className="text-[10px] font-bold text-[#8B4513]">Auto-Sync Enabled ☁️</p>
              </div>
              <div className="bg-white p-3 rounded-2xl border-2 border-[#F4B400] text-right">
                <p className="text-[10px] font-black text-slate-400">TOTAL</p>
                <p className="font-black text-lg text-slate-700">RM {totalEstimated.toFixed(2)}</p>
              </div>
            </div>
          </header>

          <main className="max-w-5xl mx-auto p-4">
            {statusMsg.text && (
              <div className={`mb-4 p-3 rounded-xl text-center font-bold text-sm shadow-sm animate-fade-in ${
                statusMsg.type === 'success' ? 'bg-green-100 text-green-700 border border-green-200' : 
                statusMsg.type === 'error' ? 'bg-red-100 text-red-700 border border-red-200' :
                'bg-blue-100 text-blue-700 border border-blue-200'
              }`}>
                {statusMsg.text}
              </div>
            )}

            <div className="flex gap-4 mb-6">
              <button onClick={() => setActiveTab('list')} className={`flex-1 py-3 rounded-xl font-black transition-all ${activeTab === 'list' ? 'bg-[#E63946] text-white shadow-lg scale-105' : 'bg-white text-[#8B4513]'}`}>SENARAI</button>
              <button onClick={() => setActiveTab('market')} className={`flex-1 py-3 rounded-xl font-black transition-all ${activeTab === 'market' ? 'bg-[#E63946] text-white shadow-lg scale-105' : 'bg-white text-[#8B4513]'}`}>KATALOG</button>
            </div>

            {activeTab === 'list' ? (
              <div className="space-y-4 animate-fade-in">
                <div className="flex justify-between items-center gap-2">
                  <button 
                    onClick={loadDataFromSheets} 
                    disabled={isLoading}
                    className="flex-1 flex items-center justify-center gap-2 bg-blue-500 text-white px-4 py-3 rounded-xl text-xs font-black shadow-md active:scale-95 disabled:opacity-50"
                  >
                    <Icon name="RefreshCw" size={14} className={isLoading ? 'animate-spin' : ''} /> 
                    {isLoading ? 'SYNCING...' : 'SYNC DATA'}
                  </button>
                  <button 
                    onClick={saveDataToSheets} 
                    disabled={isLoading}
                    className="flex-1 flex items-center justify-center gap-2 bg-green-500 text-white px-4 py-3 rounded-xl text-xs font-black shadow-md active:scale-95 disabled:opacity-50"
                  >
                    <Icon name="CloudUpload" size={14} /> SIMPAN KE CLOUD
                  </button>
                </div>
                
                <div className="bg-white rounded-3xl shadow-xl overflow-hidden border-t-8 border-red-500">
                  {myList.length === 0 ? (
                    <div className="p-16 text-center">
                      <div className="bg-slate-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                         <Icon name="ShoppingCart" size={32} color="#CBD5E1" />
                      </div>
                      <p className="text-slate-400 font-bold">Senarai masih kosong.</p>
                      <p className="text-[10px] text-slate-300">Tekan SYNC atau tambah dari KATALOG.</p>
                    </div>
                  ) : (
                    <div className="divide-y divide-slate-50">
                      {myList.map(item => (
                        <div key={item.id} className="p-4 flex items-center justify-between hover:bg-yellow-50/30">
                          <div className="flex items-center gap-3">
                            <button onClick={() => toggleCheck(item.id)} className={`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${item.checked ? 'bg-red-500 border-red-500 text-white shadow-inner' : 'border-yellow-400 bg-white'}`}>
                              {item.checked && <Icon name="Check" size={16} strokeWidth={4} />}
                            </button>
                            <div>
                              <p className={`font-black text-sm ${item.checked ? 'line-through text-slate-300' : 'text-slate-700'}`}>{item.name}</p>
                              <p className="text-[10px] text-yellow-500 font-black uppercase tracking-tighter">{item.category}</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-3">
                            <div className="flex items-center bg-slate-100 rounded-full p-1">
                              <button onClick={() => updateQuantity(item.id, -1)} className="p-1 text-slate-500"><Icon name="Minus" size={12} /></button>
                              <span className="px-2 font-black text-xs min-w-[20px] text-center">{item.quantity}</span>
                              <button onClick={() => updateQuantity(item.id, 1)} className="p-1 text-slate-500"><Icon name="Plus" size={12} /></button>
                            </div>
                            <p className="font-black text-sm w-16 text-right text-slate-600">RM {(item.price * item.quantity).toFixed(2)}</p>
                            <button onClick={() => removeFromList(item.id)} className="text-slate-200 hover:text-red-400 transition-colors">
                              <Icon name="Trash2" size={16} />
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            ) : (
              <div className="grid grid-cols-2 gap-4 animate-fade-in">
                {[
                  { id: 1, name: 'Sayur Midin', price: 4.50, category: 'Sayur' },
                  { id: 2, name: 'Ikan Terubuk', price: 15.00, category: 'Ikan' },
                  { id: 3, name: 'Beras Bario', price: 18.00, category: 'Beras' },
                  { id: 4, name: 'Telur Gred A', price: 17.50, category: 'Barangan' }
                ].map(item => {
                  const exists = myList.find(i => i.name === item.name);
                  return (
                    <button 
                      key={item.id} 
                      onClick={() => !exists && addToMyList(item)} 
                      className={`p-4 rounded-2xl border-4 text-left transition-all active:scale-95 ${
                        exists ? 'bg-red-50 border-red-100 opacity-60' : 'bg-white border-[#FFD93D] shadow-md'
                      }`}
                    >
                      <div className="flex justify-between items-start mb-2">
                        <span className="bg-yellow-100 text-yellow-700 text-[8px] font-black px-2 py-0.5 rounded-full uppercase">{item.category}</span>
                        {exists && <Icon name="CheckCircle" size={14} className="text-red-500" />}
                      </div>
                      <p className="font-black text-xs text-slate-700 mb-1">{item.name}</p>
                      <p className="text-[#E63946] font-black text-sm">RM {item.price.toFixed(2)}</p>
                    </button>
                  );
                })}
              </div>
            )}
          </main>
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
